import { createContext, useContext, useMemo, useState } from 'react';

const STORAGE_KEY = 'mx-lang';

const translations = {
  en: {
    'nav.host': 'Host',
    'nav.join': 'Join',
    'nav.tagline': 'Lightweight screen share signaling',
    'nav.language': 'Language',
    'common.none': 'none',
    'common.waiting': 'waiting',
    'landing.badge': 'MVP Phase 1',
    'landing.title': 'Fast, reliable screen share signaling.',
    'landing.desc':
      'MiraxShare is a lightweight WebRTC signaling experience focused on screen sharing. Start a session, invite a viewer, and keep the flow simple.',
    'landing.ctaHost': 'Host a session',
    'landing.ctaJoin': 'Join a session',
    'landing.ctaWindows': 'Download for Windows',
    'landing.ctaWindowsHint':
      'Having issues with web audio? Download the desktop version for better system audio.',
    'landing.browserNote': 'Works best in Chrome or Edge for screen sharing.',
    'landing.howTitle': 'How it works',
    'landing.step1Title': 'Host creates a room',
    'landing.step1Detail': 'Generate a short room ID and connect to signaling.',
    'landing.step2Title': 'Viewer joins with the ID',
    'landing.step2Detail': 'The host receives the join event and starts sharing.',
    'landing.step3Title': 'WebRTC negotiates directly',
    'landing.step3Detail': 'Only offers, answers, and ICE are relayed.',
    'landing.card1Title': 'Focused signaling',
    'landing.card1Detail': 'No media routing. Just a clean WS relay for offers/ICE.',
    'landing.card2Title': 'Designed to scale',
    'landing.card2Detail': 'Room model prepares for multi-viewer fan-out.',
    'landing.card3Title': 'Local-first MVP',
    'landing.card3Detail': 'Runs locally with minimal configuration and no auth.',
    'host.roomTitle': 'Room',
    'host.copy': 'Copy',
    'host.screenShareTitle': 'Screen share',
    'host.startShare': 'Start screen share',
    'host.stopShare': 'Stop',
    'host.qualityLabel': 'Quality',
    'host.captureSourceLabel': 'Capture source',
    'host.captureRefresh': 'Refresh',
    'host.captureSourceLoading': 'Loading...',
    'host.captureSourceEmpty': 'No screens or windows found',
    'host.captureSourceHint': 'In Electron, choose a source here before sharing.',
    'host.electronAudioEnabled':
      'Electron host uses native WASAPI loopback with high-quality Opus tuning (no microphone).',
    'host.audioTip': 'Tip: enable “Share audio” in the browser dialog to include system sound.',
    'host.audioBestTip': 'Best audio: share a browser tab when possible.',
    'host.previewTitle': 'Screen preview',
    'host.previewNote': 'This is the local preview of your shared screen (muted).',
    'host.logTitle': 'Host event log',
    'host.hostRole': 'Host role: {{peerId}}',
    'host.hostRoleWaiting': 'Host role: waiting',
    'host.limitNotice': 'MVP supports up to 6 viewers. Additional viewers will be ignored.',
    'host.errorShare': 'Screen share permission denied or unavailable.',
    'host.errorSourceLoad': 'Could not load screen or window sources.',
    'host.errorSourceRequired': 'Select a screen or window before sharing.',
    'host.errorSystemAudio': 'Unable to start stable system audio capture in Electron.',
    'host.errorCopy': 'Unable to copy room ID',
    'status.wsConnected': 'WS connected',
    'status.wsDisconnected': 'WS disconnected',
    'status.roomJoined': 'Room joined',
    'status.joining': 'Joining',
    'status.viewerConnected': 'Viewer connected',
    'status.noViewer': 'No viewer',
    'status.viewers': 'Viewers {{count}} / {{max}}',
    'status.connections': 'Connections {{count}}',
    'status.sharing': 'Sharing',
    'status.notSharing': 'Not sharing',
    'status.hostAvailable': 'Host available',
    'status.waitingHost': 'Waiting for host',
    'status.notJoined': 'Not joined',
    'status.pc': 'PC {{state}}',
    'pc.idle': 'idle',
    'pc.connected': 'connected',
    'pc.connecting': 'connecting',
    'pc.disconnected': 'disconnected',
    'pc.failed': 'failed',
    'pc.closed': 'closed',
    'pc.new': 'new',
    'join.title': 'Join a room',
    'join.placeholder': 'Enter room ID',
    'join.button': 'Join',
    'join.disconnect': 'Disconnect',
    'join.viewerId': 'Viewer ID: {{peerId}}',
    'join.errorEmptyRoom': 'Please enter a room ID.',
    'join.errorWs': 'WebSocket is not connected yet.',
    'join.liveViewTitle': 'Live view',
    'join.fillScreen': 'Fill screen',
    'join.fitScreen': 'Fit screen',
    'join.fullscreen': 'Fullscreen',
    'join.volume': 'Volume',
    'join.videoHint': 'Video will appear here once the host starts sharing.',
    'join.logTitle': 'Viewer event log',
    'logPanel.title': 'Event log',
    'logPanel.show': 'Show logs',
    'logPanel.hide': 'Hide logs',
    'logPanel.empty': 'No events yet.',
    'log.wsConnected': 'WS connected',
    'log.welcome': 'welcome',
    'log.join': 'join',
    'log.joined': 'joined',
    'log.peers': 'peers',
    'log.peerJoined': 'peer-joined',
    'log.peerLeft': 'peer-left',
    'log.signal': 'signal',
    'log.quality': 'quality',
    'log.constraints': 'constraints',
    'log.screen': 'screen',
    'log.status': 'status',
    'log.error': 'error',
    'log.clipboard': 'clipboard',
    'log.limit': 'limit',
    'log.peerId': 'peerId {{id}}',
    'log.room': 'room {{roomId}}',
    'log.hostId': 'hostId {{hostId}}',
    'log.peersCount': '{{count}} already connected',
    'log.peerRole': '{{peerId}} ({{role}})',
    'log.viewerIgnored': 'viewer ignored',
    'log.offerSent': 'offer sent',
    'log.answerReceived': 'answer received',
    'log.answerSent': 'answer sent',
    'log.iceAdded': 'ice candidate added',
    'log.iceFailed': 'ice candidate failed',
    'log.captureStarted': 'capture started',
    'log.captureStopped': 'capture stopped',
    'log.waitingViewer': 'waiting for viewer to join',
    'log.screenShareFailed': 'screen share failed',
    'log.captureSet': 'capture set to {{preset}}',
    'log.constraintsRejected': 'capture constraints rejected by browser',
    'log.audioEnabled': 'audio enabled',
    'log.systemAudio': 'system-audio',
    'log.systemAudioStarted': 'native loopback started',
    'log.systemAudioStopped': 'native loopback stopped',
    'log.systemAudioFailed': 'native loopback failed',
    'roles.host': 'host',
    'roles.viewer': 'viewer',
    'members.title': 'Members',
    'members.empty': 'No members yet.',
    'members.you': 'you',
    'members.unknown': 'Unknown',
    'user.title': 'Choose a display name',
    'user.subtitle': 'We use this name to show who is connected in the room.',
    'user.placeholder': 'Your name',
    'user.save': 'Continue',
    'user.note': 'This is required to host or join a session.',
    'user.errorRequired': 'Please enter a name to continue.',
  },
  es: {
    'nav.host': 'Host',
    'nav.join': 'Unirse',
    'nav.tagline': 'Señalización ligera para compartir pantalla',
    'nav.language': 'Idioma',
    'common.none': 'ninguno',
    'common.waiting': 'esperando',
    'landing.badge': 'MVP Fase 1',
    'landing.title': 'Señalización rápida y confiable para compartir pantalla.',
    'landing.desc':
      'MiraxShare es una experiencia ligera de señalización WebRTC enfocada en compartir pantalla. Inicia una sesión, invita a un viewer y mantén el flujo simple.',
    'landing.ctaHost': 'Crear sesión',
    'landing.ctaJoin': 'Unirse a una sesión',
    'landing.ctaWindows': 'Descargar para Windows',
    'landing.ctaWindowsHint':
      'Tienes problemas con el audio web? Descarga la version de escritorio para mejor audio del sistema.',
    'landing.browserNote': 'Funciona mejor en Chrome o Edge para compartir pantalla.',
    'landing.howTitle': 'Cómo funciona',
    'landing.step1Title': 'El host crea una sala',
    'landing.step1Detail': 'Genera un ID corto y conecta a señalización.',
    'landing.step2Title': 'El viewer se une con el ID',
    'landing.step2Detail': 'El host recibe el evento y comienza a compartir.',
    'landing.step3Title': 'WebRTC negocia directamente',
    'landing.step3Detail': 'Solo se reenvían offer, answer e ICE.',
    'landing.card1Title': 'Señalización enfocada',
    'landing.card1Detail': 'Sin ruteo de medios. Solo relay WS para offer/ICE.',
    'landing.card2Title': 'Diseñado para escalar',
    'landing.card2Detail': 'El modelo de salas prepara el fan-out a varios viewers.',
    'landing.card3Title': 'MVP local primero',
    'landing.card3Detail': 'Corre localmente con configuración mínima y sin auth.',
    'host.roomTitle': 'Sala',
    'host.copy': 'Copiar',
    'host.screenShareTitle': 'Compartir pantalla',
    'host.startShare': 'Iniciar compartir pantalla',
    'host.stopShare': 'Detener',
    'host.qualityLabel': 'Calidad',
    'host.captureSourceLabel': 'Fuente de captura',
    'host.captureRefresh': 'Actualizar',
    'host.captureSourceLoading': 'Cargando...',
    'host.captureSourceEmpty': 'No se encontraron pantallas o ventanas',
    'host.captureSourceHint': 'En Electron, elige aquí la fuente antes de compartir.',
    'host.electronAudioEnabled':
      'En Electron host usamos WASAPI loopback nativo con Opus de alta calidad (sin micrófono).',
    'host.audioTip': 'Tip: activa “Share audio” en el diálogo para incluir sonido del sistema.',
    'host.audioBestTip': 'Mejor audio: comparte una pestaña del navegador cuando sea posible.',
    'host.previewTitle': 'Vista previa',
    'host.previewNote': 'Esta es la vista previa local de tu pantalla (silenciada).',
    'host.logTitle': 'Registro de eventos del host',
    'host.hostRole': 'Rol host: {{peerId}}',
    'host.hostRoleWaiting': 'Rol host: esperando',
    'host.limitNotice': 'El MVP soporta hasta 6 viewers. Se ignorarán viewers adicionales.',
    'host.errorShare': 'Permiso de compartir pantalla denegado o no disponible.',
    'host.errorSourceLoad': 'No se pudieron cargar las fuentes de pantalla o ventana.',
    'host.errorSourceRequired': 'Selecciona una pantalla o ventana antes de compartir.',
    'host.errorSystemAudio': 'No se pudo iniciar la captura estable de audio del sistema en Electron.',
    'host.errorCopy': 'No se pudo copiar el ID de sala',
    'status.wsConnected': 'WS conectado',
    'status.wsDisconnected': 'WS desconectado',
    'status.roomJoined': 'Sala unida',
    'status.joining': 'Uniendo',
    'status.viewerConnected': 'Viewer conectado',
    'status.noViewer': 'Sin viewer',
    'status.viewers': 'Viewers {{count}} / {{max}}',
    'status.connections': 'Conexiones {{count}}',
    'status.sharing': 'Compartiendo',
    'status.notSharing': 'Sin compartir',
    'status.hostAvailable': 'Host disponible',
    'status.waitingHost': 'Esperando host',
    'status.notJoined': 'No unido',
    'status.pc': 'PC {{state}}',
    'pc.idle': 'inactivo',
    'pc.connected': 'conectado',
    'pc.connecting': 'conectando',
    'pc.disconnected': 'desconectado',
    'pc.failed': 'fallo',
    'pc.closed': 'cerrado',
    'pc.new': 'nuevo',
    'join.title': 'Unirse a una sala',
    'join.placeholder': 'Ingresa el ID de sala',
    'join.button': 'Unirse',
    'join.disconnect': 'Desconectarse',
    'join.viewerId': 'Viewer ID: {{peerId}}',
    'join.errorEmptyRoom': 'Ingresa un ID de sala.',
    'join.errorWs': 'WebSocket aún no está conectado.',
    'join.liveViewTitle': 'Vista en vivo',
    'join.fillScreen': 'Llenar pantalla',
    'join.fitScreen': 'Ajustar pantalla',
    'join.fullscreen': 'Pantalla completa',
    'join.volume': 'Volumen',
    'join.videoHint': 'El video aparecerá aquí cuando el host comience a compartir.',
    'join.logTitle': 'Registro de eventos del viewer',
    'logPanel.title': 'Registro de eventos',
    'logPanel.show': 'Mostrar',
    'logPanel.hide': 'Ocultar',
    'logPanel.empty': 'Aún no hay eventos.',
    'log.wsConnected': 'WS conectado',
    'log.welcome': 'welcome',
    'log.join': 'join',
    'log.joined': 'joined',
    'log.peers': 'peers',
    'log.peerJoined': 'peer-joined',
    'log.peerLeft': 'peer-left',
    'log.signal': 'signal',
    'log.quality': 'calidad',
    'log.constraints': 'restricciones',
    'log.screen': 'pantalla',
    'log.status': 'estado',
    'log.error': 'error',
    'log.clipboard': 'clipboard',
    'log.limit': 'límite',
    'log.peerId': 'peerId {{id}}',
    'log.room': 'sala {{roomId}}',
    'log.hostId': 'hostId {{hostId}}',
    'log.peersCount': '{{count}} ya conectados',
    'log.peerRole': '{{peerId}} ({{role}})',
    'log.viewerIgnored': 'viewer ignorado',
    'log.offerSent': 'offer enviado',
    'log.answerReceived': 'answer recibido',
    'log.answerSent': 'answer enviado',
    'log.iceAdded': 'ICE agregado',
    'log.iceFailed': 'ICE fallido',
    'log.captureStarted': 'captura iniciada',
    'log.captureStopped': 'captura detenida',
    'log.waitingViewer': 'esperando a que se una un viewer',
    'log.screenShareFailed': 'fallo al compartir pantalla',
    'log.captureSet': 'captura ajustada a {{preset}}',
    'log.constraintsRejected': 'restricciones de captura rechazadas por el navegador',
    'log.audioEnabled': 'audio habilitado',
    'log.systemAudio': 'system-audio',
    'log.systemAudioStarted': 'loopback nativo iniciado',
    'log.systemAudioStopped': 'loopback nativo detenido',
    'log.systemAudioFailed': 'loopback nativo falló',
    'roles.host': 'host',
    'roles.viewer': 'viewer',
    'members.title': 'Miembros',
    'members.empty': 'Aún no hay miembros.',
    'members.you': 'tú',
    'members.unknown': 'Desconocido',
    'user.title': 'Elige un nombre visible',
    'user.subtitle': 'Usamos este nombre para mostrar quién está conectado en la sala.',
    'user.placeholder': 'Tu nombre',
    'user.save': 'Continuar',
    'user.note': 'Es obligatorio para crear o unirse a una sesión.',
    'user.errorRequired': 'Ingresa un nombre para continuar.',
  },
};

const I18nContext = createContext({
  lang: 'en',
  setLang: () => {},
  t: (key) => key,
});

function getInitialLang() {
  if (typeof window === 'undefined') return 'en';
  try {
    const stored = window.localStorage.getItem(STORAGE_KEY);
    if (stored && translations[stored]) return stored;
  } catch (_err) {
    return 'en';
  }
  return 'en';
}

function translate(lang, key, vars = {}) {
  const table = translations[lang] || translations.en;
  const fallback = translations.en;
  const template = table[key] || fallback[key] || key;
  return template.replace(/\{\{(\w+)\}\}/g, (_match, token) => {
    return vars[token] ?? '';
  });
}

export function I18nProvider({ children }) {
  const [lang, setLangState] = useState(getInitialLang());

  const setLang = (next) => {
    if (!translations[next]) return;
    setLangState(next);
    try {
      window.localStorage.setItem(STORAGE_KEY, next);
    } catch (_err) {
      // Ignore storage failures.
    }
  };

  const value = useMemo(
    () => ({
      lang,
      setLang,
      t: (key, vars) => translate(lang, key, vars),
    }),
    [lang]
  );

  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>;
}

export function useI18n() {
  return useContext(I18nContext);
}
